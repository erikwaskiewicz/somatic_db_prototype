{% load crispy_forms_tags %}

<!-- this tab is only rendered if there are still checks to perform -->

<h5>Comments</h5>
<table class="table table-sm table-striped table-hover">
  <thead>
    <tr>
      <th class="col-1"></th>
      <th class="col-1">Pass/fail</th>
      <th class="col-1">Patient info check</th>
      <th class="col-2">User</th>
      <th class="col-7">Comment</th>
    </tr>
  </thead>
  {% for check in sample_data.checks.all_checks %}
  <tbody>
    <tr>
      <td>{{ forloop.counter }}</td>
      <td>
        {% if check.status ==  'C' %}
        <span class="badge badge-pill badge-success">Pass</span>
        {% elif check.status ==  '-' %}
        <span class="badge badge-pill badge-secondary">{{ check.get_status_display }}</span>
        {% else %}
        <span class="badge badge-pill badge-danger">{{ check.get_status_display }}</span>
        {% endif %}
      </td>
      <td>{{ check.patient_info_check }}</td>
      <td>{{ check.user }}<br>{% firstof check.signoff_time '' %}</td>
      <td>{{ check.overall_comment | wordwrap:80 | linebreaksbr }}</td>
    </tr>
  </tbody>
  {% endfor %}
</table>

{% if 'Bioinformatics QC' in sample_data.status %}
<br>
<br>
<div class="alert alert-danger">
  <h5>Sample failed bioinformatics QC?</h5>
  <br>
  {% crispy sample_qc_form %}

  {% if sample_data.checks.previous_check_object %}
  <button class="btn btn-secondary w-100" type="button" data-toggle="modal" data-target="#send-back-modal">Send check back</button>
  {% endif %}
</div>

{% elif 'IGV' in sample_data.status %}
<div class="card-body">
  {% crispy sample_comment_form %}
</div>
<br>
<br>

<div class="card-body bg-light">

  <h5>Analysis complete?</h5>
  <br>
  <button class="btn btn-info" style="width:49%;" type="button" data-toggle="modal" data-target="#finalise-modal">Complete check</button>
  {% if sample_data.checks.previous_check_object %}
  <button class="btn btn-info" style="width:49%;" type="button" data-toggle="modal" data-target="#send-back-modal">Send check back</button>
  {% else %}
  <button class="btn btn-info disabled" style="width:49%;" type="button">Send check back</button>
  {% endif %}

</div>

{% endif %}

<!-- sign off modal -->
<div class="modal fade" id="finalise-modal" tabindex="-1" role="dialog" aria-labelledby="finalise-modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="finalise-modalLabel">Complete check</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        {% include 'analysis/forms/finalise_form.html' %}
      </div>
    </div>
  </div>
</div>


<!-- send back modal -->
<div class="modal fade" id="send-back-modal" tabindex="-1" role="dialog" aria-labelledby="send-back-modalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="send-back-modalLabel">Send back to previous check?</h5>
        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">

        {% if sample_data.checks.previous_check_object %}
        <div class="alert alert-danger" role="alert">
          <h5><span class="fa fa-exclamation-triangle" style="color:firebrick"></span> Warning</h5>
          <p>Sending a check back will remove your check permanently, are you sure you want to continue?</p>
          <p>Sample will be sent back to <strong>{{ sample_data.checks.previous_check_object.user }}</strong>, please let them know that you are sending this back to them</p>
          <br>
          {% crispy send_back_form %}
        </div>

        {% else %}
        <div class="alert alert-info" role="alert">
          <p>There isn't a previous check to send back to</p>
        </div>

        {% endif %}
      </div>
    </div>
  </div>
</div>



<script>

function load_variables() {
    // load in elements of form that will require show/hiding
    finalise_form_check_1 = document.getElementById("finalise_form_check_1");
    finalise_form_check_2 = document.getElementById("finalise_form_check_2");
    finalise_form_check_3 = document.getElementById("finalise_form_check_3");
    finalise_form_pass_fail = document.getElementById("finalise_form_pass_fail");
    finalise_form_next_step = document.getElementById("finalise_form_next_step");

    // load in buttons that will need editting
    pass_button = document.getElementById("id_analysis_pass_fail_0").parentElement
    fail_button = document.getElementById("id_analysis_pass_fail_1").parentElement
    extra_check_button = document.getElementById("id_next_step_0").parentElement
    complete_button = document.getElementById("id_next_step_1").parentElement
}

function set_up_form() {
    // add button specific CSS class for pass/fail
    pass_button.classList.add("btn-outline-success");
    fail_button.classList.add("btn-outline-danger");

    // unset button CSS display
    pass_button.classList.remove("active")
    fail_button.classList.remove("active")
    extra_check_button.classList.remove("active")
    complete_button.classList.remove("active")

    // remove values from all form buttons TODO - should specifiy which forms, will probably remove from the entire analysis page
    $( 'input[type="radio"]' ).prop('checked', false);

    // hide all but first check
    finalise_form_pass_fail.style.display = "none";
    finalise_form_check_2.style.display = "none";
    finalise_form_check_3.style.display = "none";
    finalise_form_next_step.style.display = "none";
}

function ajax_call(option_selected) {
    // handle AJAX and show/hiding of form sections when the analysis pass/fail buttons are pressed
    //


    // display second check box
    finalise_form_check_2.style.display = "block";

    // hide and reset next step form
    finalise_form_check_3.style.display = "none";
    finalise_form_next_step.style.display = "none";
    extra_check_button.classList.remove("active")
    complete_button.classList.remove("active")

    // AJAX call for check
    $.ajax({
        url: "{% url 'ajax_finalise_check' %}",
        type: 'GET',
        data: {
            'current_check': '{{ sample_data.checks.current_check_object.pk }}',
            'option_selected': option_selected,
        },
        success: function(data) {
            setTimeout(function() {
                // replace loading alert with response HTML for check 2
                $(finalise_form_check_2).replaceWith(data.html_check_2);

                // reload html elements otherwise they wont be recognised
                load_variables();

                // if its a pass, show the next check section
                if (data.pass_check_2 === true) {
                  finalise_form_check_3.style.display = "block";

                  setTimeout(function() {
                      // replace loading alert with response HTML for check 3
                      $(finalise_form_check_3).replaceWith(data.html_check_3);

                      // reload html elements otherwise they wont be recognised
                      load_variables();

                      // display final section of form and disable complete button if check 3 fails
                      finalise_form_next_step.style.display = "block"
                      if (data.pass_check_3 === false) {
                          complete_button.classList.add("disabled");
                      }
                  }, 750);
                }
            }, 750)
        },
        failure: function(data) {
            alert('Got an error');
        }
    });
}


  $(document).ready(function(){

      // on page load
      //load_variables();
      //set_up_form();

      var orig_form = $("#finalise_form").clone()
      console.log(orig_form)


      $("#finalise-modal").on('hide.bs.modal', function(){
        $("#finalise_form").replaceWith(orig_form);
        //console.log(orig_form[0].childNodes[3])
        load_variables();
        set_up_form();
      });
      // when modal is opened
      $("#finalise-modal").on('show.bs.modal', function(){

          // TODO reset template + form each time modal is opened
          //$("#finalise_form").replaceWith(orig_form);
          load_variables();
          set_up_form();
          console.log($('#finalise_form_next_step input')[0].checked);
          console.log($('#finalise_form_next_step input')[1].checked);
          console.log($('#finalise_form_next_step input')[2].checked);
          //$('#finalise_form_next_step input')[1].checked;
          //$('#finalise_form_next_step input')[2].checked;
          // TODO move JS to own file



          // AJAX call on for demographics check
          $.ajax({
              url: "{% url 'ajax_finalise_check' %}",
              type: 'GET',
              data: {
                  'current_check': '{{ sample_data.checks.current_check_object.pk }}',
                  'option_selected': 'demographics',
              },
              success: function(data) {
                  setTimeout(function() {
                      // replace loading box with htlm from response
                      $(finalise_form_check_1).replaceWith(data.html);

                      // if its a pass, show the next step
                      if (data.pass === true) {
                        finalise_form_pass_fail.style.display = "block"
                      }
                  }, 750)
              },
              failure: function(data) {
                  alert('Got an error');
              }
          });

          // AJAX call when pass button pressed
          $('#id_analysis_pass_fail_0').on('click', function(event) {
              ajax_call('next_step_pass')
          });

          // AJAX call when fail button pressed
          $('#id_analysis_pass_fail_1').on('click', function(event) {
              ajax_call('next_step_fail')
          });
      });
  });
</script>